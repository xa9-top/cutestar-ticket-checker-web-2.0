<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é—¨ç¥¨æ ¸éªŒ</title>
    <style>
        /* å…¬å…±æ ·å¼ */
        body {
            margin: 0;
            padding: 0;
            font-family: "é»‘ä½“";
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-image: url("../image/bg.jpg");
            background-size: cover;
            background-repeat: no-repeat;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .main {
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            padding: 40px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 800px;
            width: 90%;
        }

        /* æ ‡é¢˜æ ·å¼ */
        .title {
            color: #FF69B4;
            font-size: 32px;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* å†…å®¹æ ·å¼ */
        .content {
            color: #0082FF;
            font-size: 18px;
            line-height: 1.8;
        }

        /* çŠ¶æ€æç¤º */
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 1);
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin: 20px 0;
        }

        input[type="text"] {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(219, 236, 255, 0.9);
            width: 70%;
            font-size: 16px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        input[type="submit"] {
            padding: 12px 30px;
            background: #3B99FC;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        input[type="submit"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
        }

        /* æ¶ˆæ¯æ ·å¼ */
        .message-content {
            background-color: #f1f1f1;
            margin: 0;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
            padding: 20px;
            border: 1px solid #3B99FC;
            width: 60%;
            max-width: 400px;
            height: auto;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            /* å¢åŠ äº†æ¨¡ç³ŠåŠå¾„å’Œé¢œè‰²å¼ºåº¦ */
            opacity: 0;
            /* åˆå§‹ä¸é€æ˜åº¦ä¸º0 */
            visibility: hidden;
            /* åˆå§‹éšè— */
            transition: opacity 0.3s ease, visibility 0.3s ease;
            /* æ·»åŠ è¿‡æ¸¡æ•ˆæœ */
        }

        /* æ‘„åƒå¤´é¢„è§ˆæ ·å¼ */
        .camera-view {
            width: auto;
            max-width: 600px;
            height: 300px;
            background: #000;
            border-radius: 12px;
            margin: 20px auto;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            transform: translateZ(0);
            /* ç¡¬ä»¶åŠ é€Ÿ */
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            body {
                display: block;
                /* ç§»é™¤flexå¸ƒå±€ */
            }

            .overlay {
                width: 100vw;
                height: 100vh;
                padding: 0;
                align-items: stretch;
                /* æ‹‰ä¼¸å­å…ƒç´  */
            }

            .main {
                width: 100% !important;
                height: 100% !important;
                min-height: 100vh !important;
                max-width: none !important;
                border-radius: 0 !important;
                padding: 1rem;
                box-shadow: none !important;
            }

            .title {
                font-size: 6vw;
                margin: 2vh 0;
            }

            .content {
                height: auto !important;
                /* åŠ¨æ€é«˜åº¦ */
                min-height: calc(100vh - 120px);
                display: flex;
                flex-direction: column;
                overflow-y: hidden;
            }

            .camera-view {
                width: 100% !important;
                height: 40vh !important;
                max-width: none !important;
                margin: 10px 0;
            }

            /* é˜²æ­¢å†…å®¹æº¢å‡ºå®¹å™¨ */
            html,
            body {
                overflow-x: hidden;
                max-width: 100vw;
            }

            /* è¾“å…¥æ¡†ä¿®æ­£ */
            .form-group {
                width: 100%;
                padding: 0;
                /* æ¸…é™¤å¯èƒ½å­˜åœ¨çš„é»˜è®¤padding */
                margin: 0;
            }

            input[type="text"] {
                box-sizing: border-box;
                /* åŒ…å«paddingåœ¨å®½åº¦å†… */
                width: 100% !important;
                max-width: 100%;
                padding: 12px 15px !important;
                font-size: 16px !important;
                /* å›ºå®šå­—ä½“å¤§å° */
                border: 1px solid #ddd !important;
                /* æ·»åŠ è¾¹ç•Œé¿å…è§†è§‰æº¢å‡º */

                /* å¤„ç†é•¿æ–‡æœ¬ */
                white-space: pre-wrap;
                /* å…è®¸è‡ªåŠ¨æ¢è¡Œ */
                word-break: break-all;
                /* å¼ºåˆ¶é•¿å•è¯æ¢è¡Œ */
            }

            /* è¡¨å•ç»„é—´è·è°ƒæ•´ */
            .form-group {
                margin: 15px 0 !important;
                /* ç»Ÿä¸€ä¸Šä¸‹é—´è· */
                width: 100%;
                padding: 0;
            }

            /* è¾“å…¥æ¡†ä¸“ç”¨é—´è· */
            .form-group:first-child {
                margin-bottom: 25px !important;
                /* è¾“å…¥æ¡†ä¸æŒ‰é’®ä¹‹é—´çš„é—´è· */
            }

            /* è¾“å…¥æ¡†æ ·å¼ */
            input[type="text"] {
                box-sizing: border-box;
                width: 100% !important;
                padding: 14px 16px !important;
                /* åŠ å¤§å†…è¾¹è· */
                font-size: 16px !important;
                border: 1px solid #ddd !important;
                border-radius: 8px !important;
                /* æ·»åŠ åœ†è§’ */
                margin: 0;
                white-space: pre-wrap;
                word-break: break-all;
                box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
                /* å†…é˜´å½±å¢å¼ºå±‚æ¬¡æ„Ÿ */
            }

            /* æŒ‰é’®ä¸“ç”¨æ ·å¼ */
            input[type="submit"] {
                width: 100% !important;
                padding: 14px 16px !important;
                /* ä¸è¾“å…¥æ¡†ä¿æŒç›¸åŒé«˜åº¦ */
                font-size: 17px !important;
                /* ç•¥å¤§äºè¾“å…¥æ–‡å­— */
                border-radius: 8px !important;
                margin-top: 10px !important;
                /* é¢å¤–å¢åŠ ä¸Šè¾¹è· */
                transition: all 0.2s ease;
            }

            /* æŒ‰é’®äº¤äº’ä¼˜åŒ– */
            input[type="submit"]:active {
                transform: scale(0.98);
                /* ç‚¹å‡»æ—¶è½»å¾®ç¼©æ”¾ */
                opacity: 0.9;
            }

            /* è¡¨å•å®¹å™¨ä¿®æ­£ */
            #myForm {
                width: 100%;
                padding: 0 5px;
                /* æ·»åŠ å®‰å…¨è¾¹è· */
                box-sizing: border-box;
            }

            /* çŠ¶æ€ä¿¡æ¯é˜²æº¢å‡º */
            .status-details {
                max-width: 100%;
                word-wrap: break-word;
            }

            .status-details {
                padding: 0 5px;
            }

            .detail-item {
                font-size: 4.5vw;
                padding: 8px 0;
            }

            .toggle-button {
                position: fixed;
                top: 12px;
                right: 12px;
                font-size: 4vw;
                padding: 8px 16px;
            }
        }

        /* æ˜¾ç¤ºæ—¶çš„æ ·å¼ */
        .message-content.show {
            opacity: 1;
            /* æ˜¾ç¤ºæ—¶é€æ˜åº¦ä¸º1 */
            visibility: visible;
            /* æ˜¾ç¤ºæ—¶å¯è§ */
        }

        /* åŒåˆ—å¸ƒå±€æ ·å¼ */
        .status-details {
            display: flex;
            gap: 20px;
            justify-content: space-between;
            text-align: left;
        }

        .detail-column {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .detail-item {
            padding: 8px 0;
            border-bottom: 1px dashed #ddd;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-item {
            font-size: 20px;
            /* æ–°å¢å­—ä½“å¤§å° */
        }

        .detail-item strong {
            font-size: 22px;
            /* æ ‡ç­¾åŠ ç²—æ”¾å¤§ */
            color: #2c3e50;
            /* å¢åŠ å¯¹æ¯”åº¦ */
        }

        /* æ–°å¢æ ·å¼ */
        .toggle-button {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #3B99FC;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            z-index: 2;
        }

        .toggle-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
        }

        /* æ·»åŠ éšè—ç±» */
        #video.hidden,
        #myForm.hidden {
            display: none;
        }

        #canvas {
            display: none;
        }
    </style>
</head>

<body>
    <div class="overlay">
        <div class="main">
            <div class="title">ğŸ« é—¨ç¥¨æ ¸éªŒç³»ç»Ÿ</div>
            <button id="toggleBtn" class="toggle-button">âŒ¨ï¸ åˆ‡æ¢è‡³æ‰‹åŠ¨è¾“å…¥</button>
            <div class="content">
                <!-- ç»Ÿä¸€çŠ¶æ€å®¹å™¨ -->
                <div id="statusBox" class="status-container checking">
                    <div class="status-content active" id="checking">
                        <h2 class="status-title">ğŸ” æ­£åœ¨æ£€ç¥¨ä¸­...</h2>
                    </div>

                    <div class="status-content" id="resultContent">
                        <h2 class="status-title" id="resultTitle"></h2>
                        <div class="status-details" id="resultDetails"></div>
                    </div>
                </div>
                <!-- æ‘„åƒå¤´åŒºåŸŸ -->
                <video id="video" class="camera-view" autoplay playsinline></video>
                <canvas id="canvas"></canvas>
                <!-- æ ¸éªŒè¡¨å• -->
                <form id="myForm">
                    <div class="form-group">
                        <input type="text" name="ticket_data" placeholder="è¯·è¾“å…¥ç¥¨æ•°æ®" autocomplete="off" required>
                    </div>
                    <div class="form-group">
                        <input type="submit" value="ç«‹å³æ ¸éªŒ">
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="myMessageModal" class="message-content">
        ç¥tmä¿©å¼¹çª—
    </div>
    <script src="../js/jquery.min.js"></script>
    <script src="../js/jsQR.js"></script>
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const canvasContext = canvas.getContext('2d');
        let streamGlobal = null; // æ·»åŠ ä¸€ä¸ªå…¨å±€å˜é‡æ¥å­˜å‚¨æ‘„åƒå¤´æµ
        let isScanning = true; // æ‰«æçŠ¶æ€æ ‡å¿—
        let scanningPaused = false; // åˆå¹¶æ‰«ææš‚åœçŠ¶æ€
        let animationFrameId = null; // åŠ¨ç”»å¸§IDè·Ÿè¸ª

        // ä¿®æ”¹åçš„åˆå§‹åŒ–å‡½æ•°
        function initCamera() {
            if (video.srcObject) return;
        
            navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                })
                .then(stream => {
                    video.srcObject = stream;
                    video.play()
                        .then(() => {
                            console.log('æ‘„åƒå¤´å·²æ­£å¸¸å¯åŠ¨');
                            startScanning();
                        })
                        .catch(e => console.error('è§†é¢‘æ’­æ”¾å¤±è´¥:', e));
                })
                .catch(e => {
                    console.error('æ‘„åƒå¤´è®¿é—®å¤±è´¥:', e);
                    showMessageModal('æ‘„åƒå¤´è®¿é—®è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
                    startScanning = () => {}; // ç¦ç”¨æ‰«æåŠŸèƒ½
                });
        }
        
        // å¢å¼ºçš„æ‰«ææ§åˆ¶å‡½æ•°
        function pauseScanning() {
            scanningPaused = true;
            console.log('å¼ºåˆ¶æš‚åœæ‰«æ');
        }
        
        function startScanning() {
            scanningPaused = false;
            console.log('å¼ºåˆ¶å¯åŠ¨æ‰«æ');
            
            if (!animationFrameId) {
                tick();
            }
            
            // ç¡®ä¿è§†é¢‘æµæ­£å¸¸
            if (!video.srcObject) {
                initCamera();
            } else if (video.paused) {
                video.play().catch(e => console.error('è§†é¢‘æ¢å¤å¤±è´¥:', e));
            }
        }

        // ä¼˜åŒ–åçš„tickå‡½æ•°
        function tick() {
            animationFrameId = requestAnimationFrame(tick);
        
            // ä¸‰é‡çŠ¶æ€æ£€æŸ¥
            if (!isScanning || scanningPaused || video.readyState !== video.HAVE_ENOUGH_DATA) {
                return;
            }
        
            // æ§åˆ¶æ‰«æé¢‘ç‡
            if (frameCount++ % 5 !== 0) return;
        
            canvas.height = video.videoHeight;
            canvas.width = video.videoWidth;
            canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);
        
            try {
                const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: 'dontInvert'
                });
        
                if (code) {
                    handleScannedCode(code.data);
                }
            } catch (e) {
                console.error('äºŒç»´ç è§£æé”™è¯¯:', e);
            }
        }

        
        function handleScannedCode(data) {
            isScanning = false;
            validateTicket("ticket_data=" + encodeURIComponent(data));
            
            // 3ç§’åæ¢å¤æ‰«æ
            setTimeout(() => {
                isScanning = true;
            }, 3000);
        }

        // å°è£…çš„éªŒè¯å‡½æ•°ï¼ˆå¯é€šè¿‡ validateTicket() å¤–éƒ¨è°ƒç”¨ï¼‰
        function validateTicket(formData) {
            resetUIState();

            $.ajax({
                url: 'search.php',
                type: 'POST',
                data: formData,
                dataType: 'json',
                success: handleSuccess,
                error: handleError
            });
        }

        // æˆåŠŸå¤„ç†å‡½æ•°
        function handleSuccess(data) {
            $checking.removeClass("active");

            let statusClass = "checking";
            let title = "";
            let details = "";
            let audio = audioError;

            if (data.error === "false") {
                const ticket = data.data;
                details = buildDetailsHtml(ticket);

                switch (ticket.ticket_state.toString()) {
                    case '0':
                        title = `âœ… æ£€ç¥¨æˆåŠŸï¼š${ticket.ticket_name}`;
                        statusClass = "success";
                        audio = audioSuccess;
                        break;
                    case '1':
                        title = "âš ï¸ å·²æ£€ç¥¨";
                        statusClass = "warning";
                        audio = audioWarning;
                        break;
                    case '2':
                        title = "â›” é»‘åå•ç¥¨";
                        statusClass = "fail";
                        break;
                    case '3':
                        title = "âŒ æœªå”®å‡ºç¥¨";
                        statusClass = "fail";
                        break;
                    default:
                        title = "âŒ æœªçŸ¥çŠ¶æ€";
                        statusClass = "fail";
                }
            } else {
                title = "âŒ æ— æ•ˆç¥¨è¯";
                statusClass = "fail";
            }

            updateResultUI(statusClass, title, details);
            audio.play();
            scheduleUIReset();
        }

        // é”™è¯¯å¤„ç†å‡½æ•°
        function handleError(xhr) {
            console.error("è¯·æ±‚é”™è¯¯:", xhr);
            audioError.play();
            updateResultUI("fail", "âš ï¸ ç³»ç»Ÿé”™è¯¯", "");
            scheduleUIReset();
        }

        // è¾…åŠ©å‡½æ•°
        function resetUIState() {
            $checking.addClass("active");
            $resultContent.removeClass("active");
            $statusBox.removeClass().addClass("status-container checking");
        }

        function buildDetailsHtml(ticket) {
            return `
          <div class="detail-column">
              <div class="detail-item"><strong>ç¥¨å·ï¼š</strong>${ticket.ticket_number}</div>
              <div class="detail-item"><strong>ç±»å‹ï¼š</strong>${ticket.ticket_name}</div>
          </div>
          <div class="detail-column">
              <div class="detail-item"><strong>çŠ¶æ€ï¼š</strong>${getStatusText(ticket.ticket_state)}</div>
              ${ticket.ticket_state === 0 ? `<div class="detail-item"><strong>å…¥åœºæ—¶é—´ï¼š</strong>${new Date().toLocaleString()}</div>` : ''}
              ${ticket.ticket_state === 1 ? `<div class="detail-item"><strong>é¦–æ¬¡å…¥åœºï¼š</strong>${ticket.entry_time}</div>` : ''}
          </div>`;
        }

        function updateResultUI(statusClass, title, details) {
            $statusBox.removeClass().addClass(`status-container ${statusClass}`);
            $resultTitle.html(title);
            $resultDetails.html(details);
            $resultContent.addClass("active");
        }

        function scheduleUIReset() {
            setTimeout(() => {
                $resultContent.removeClass("active");
                $checking.addClass("active");
                $statusBox.removeClass().addClass("status-container checking");
            }, 5000);
        }

        function getStatusText(state) {
            // å®ç°çŠ¶æ€æ–‡æœ¬è½¬æ¢é€»è¾‘
            const statusMap = {
                0: 'æœ‰æ•ˆ',
                1: 'å·²ä½¿ç”¨',
                2: 'é»‘åå•',
                3: 'æœªå”®å‡º'
            };
            return statusMap[state] || 'æœªçŸ¥çŠ¶æ€';
        }

        let frameCount = 0;

        const toggleBtn = document.getElementById('toggleBtn');
        const myForm = document.getElementById('myForm');

        video.classList.remove('hidden');
        myForm.classList.add('hidden');
        initCamera();

        // ä¿®å¤åçš„åˆ‡æ¢æŒ‰é’®äº‹ä»¶å¤„ç†
        toggleBtn.addEventListener('click', () => {
            // å…ˆæ‰§è¡Œåˆ‡æ¢æ“ä½œå†è·å–æœ€æ–°çŠ¶æ€
            myForm.classList.toggle('hidden');
            video.classList.toggle('hidden', !myForm.classList.contains('hidden'));
            
            // è·å–å½“å‰å®é™…æ¨¡å¼çŠ¶æ€
            const isManualMode = !myForm.classList.contains('hidden');
            toggleBtn.textContent = !isManualMode ? 'ğŸ“· åˆ‡æ¢è‡³æ‰«ææ¨¡å¼' : 'âŒ¨ï¸ åˆ‡æ¢è‡³æ‰‹åŠ¨è¾“å…¥';
        
            console.log(`åˆ‡æ¢æ¨¡å¼: ${isManualMode ? 'æ‰‹åŠ¨' : 'æ‰«æ'}`);
        
            if (isManualMode) {
                // è¿›å…¥æ‰‹åŠ¨æ¨¡å¼
                scanningPaused = true;
                console.log('å·²æš‚åœæ‰«æ');
            } else {
                // è¿”å›æ‰«ææ¨¡å¼
                scanningPaused = false;
                console.log('å·²æ¢å¤æ‰«æ');
                
                // ç¡®ä¿æ‘„åƒå¤´å·²åˆå§‹åŒ–
                if (!video.srcObject) {
                    initCamera();
                } else if (video.paused) {
                    video.play();
                }
            }
        });
    </script>
    <script>
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessageModal(message) {
            var modal = document.getElementById("myMessageModal");
            modal.textContent = message;
            modal.classList.add('show'); // æ·»åŠ 'show'ç±»ä»¥è§¦å‘è¿‡æ¸¡æ•ˆæœ
            modal.style.display = "block";

            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(function() {
                modal.classList.remove('show'); // ç§»é™¤'show'ç±»ä»¥è§¦å‘è¿‡æ¸¡æ•ˆæœ
                setTimeout(function() {
                    modal.style.display = "none";
                }, 300); // ç­‰å¾…è¿‡æ¸¡æ•ˆæœå®Œæˆåéšè—
            }, 3000);
        }
    </script>
    <script>
        fetch("search.php?auth=true")
            .then(response => response.text())
            .then(text => {
                if (text.trim() === "authfail") {
                    showMessageModal("æœªç™»å½•æˆ–ä¼šè¯è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•ï¼");
                    setTimeout(() => {
                        window.location.href = '/user/login.php?from=' + encodeURIComponent(window.location.href);
                    }, 2000);
                }
            })
    </script>

    <!-- æ·»åŠ éŸ³é¢‘å…ƒç´  -->
    <audio id="audioSuccess" src="../sound/success.wav"></audio>
    <audio id="audioWarning" src="../sound/warning.wav"></audio>
    <audio id="audioError" src="../sound/error.wav"></audio>

    <script>
        // åˆå§‹åŒ–éŸ³é¢‘å¯¹è±¡
        const audioSuccess = document.getElementById('audioSuccess');
        const audioWarning = document.getElementById('audioWarning');
        const audioError = document.getElementById('audioError');

        // çŠ¶æ€æ–‡æœ¬æ˜ å°„
        const statusText = {
            '0': 'æ£€ç¥¨é€šè¿‡',
            '1': 'å·²ä½¿ç”¨',
            '2': 'é»‘åå•',
            '3': 'æœªå”®å‡º'
        };

        function getStatusText(state) {
            return statusText[state.toString()] || 'æœªçŸ¥çŠ¶æ€';
        }
    </script>

    <script>
        // åˆå§‹åŒ–å…¨å±€å…ƒç´ å¼•ç”¨
        let $checking, $statusBox, $resultContent, $resultTitle, $resultDetails;

        $(document).ready(function() {
            // åˆå§‹åŒ–å…ƒç´ å¼•ç”¨
            $checking = $("#checking");
            $statusBox = $("#statusBox");
            $resultContent = $("#resultContent");
            $resultTitle = $("#resultTitle");
            $resultDetails = $("#resultDetails");

            // ç»‘å®šè¡¨å•æäº¤
            $("#myForm").submit(function(e) {
                e.preventDefault();
                validateTicket($(this).serialize());
                this.reset();
            });
        });
    </script>
</body>

</html>
